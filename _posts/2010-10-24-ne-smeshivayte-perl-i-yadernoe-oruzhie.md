---
id: 379
title: 'Не смешивайте Perl и ядерное оружие'
date: '2010-10-24T22:14:09+00:00'
author: serge
layout: post
guid: 'http://sotnyk.com/?p=379'
permalink: /2010/10/24/ne-smeshivayte-perl-i-yadernoe-oruzhie/
---

![](https://sotnyk.github.io/wp-content/uploads/2010/10/NuclearAlert.jpg "Red Alert!")Нашел занятный рассказ и решил поупражняться в переводе – пока русского варианта не нашел. Оригинальный текст [находится здесь](http://www.foo.be/docs/tpj/issues/vol2_1/tpj0201-0004.html). Формулы я записал в одну строку – мне так удобнее, а на повествовании это особо не сказывается. Автор – Ray F. Piodasoll. И на всякий случай – обратите внимание на текст в самом низу страницы оригинала (я его не стал переводить).  
  
Итак,  
**Не смешивайте Perl и ядерное оружие.**

Примерно шесть лет назад, я работал на компанию, занимавшуюся внедрением научных исследований для наших клиентов в оборонной индустрии – мы собирали «до кучи» различные утилиты. Хотя я окончил ROTC (Reserve Officers’ Training Corps) еще в колледже, и окончил свою обязательную норму службы в армии в чине полноправного капитана, иногда меня все же посещали приступы вины по поводу того, что я косвенно работаю на военно-промышленный комплекс. Только когда я разработал регрессионный тест для системы раннего обнаружения комет, я понял, что ракеты – это не всегда плохо. Когда комета диаметров в шесть миль готова уничтожить на Земле все живое, как это произошло 65 миллионов лет назад, когда были уничтожены динозавры и почти все живое, думаю, вы будете рады иметь ядерное оружие, которое сможет уничтожить эту комету до её прибытия на Землю. Вот так я и перешел на работу к наиболее зловещим из милитаристов – военным. В течение 18 месяцев я был в положении «Совершенно секретно» и работал на NORAD (североамериканское командование аэрокосмической обороны).

Perl в NORAD использовался совсем немного, после того, как они отказались от использования языка Ада. Они пришли к выводу, что Ада-программисты являются не теми людьми, которые могут создавать оборонные ракетные комплексы. (То же самое и с C++). Мой первый начальник вначале отмахнулся от Perl, но потом немного смягчился, когда я ему сказал, что этот язык предназначен именно для этих целей и даже был назван Perl-ом, как сокращение от «Precision Entry and Reentry Launchings» («точное попадание и повторные пуски») – за эту ложь меня когда-нибудь отдадут под военно-полевой трибунал.

К сожалению, мои бывшие работодатели не хотят, чтобы я говорил о моей работе: софте для определения начальной скорости ракет. Но несколько историй я рассказать могу, поскольку думаю, что они расскажут гораздо больше о Perl, чем о национальной безопасности. Я не хочу никого пугать в дальнейшем, но вы должны знать, насколько близко мы все подошли к ядерному Армагеддону из-за того, что я недопонял базовые концепции Perl. Сорри.

В марте 1996-го, мне было сказано написать программу, которая должна была подсчитать эффект тяги в зависимости от состава сплава для ракет Nika. Первым моим шагом был парсинг файла с координатами заклепок, который выглядел следующим образом:  
\[Perl\]  
RIVET294 3/8 004 14.25 14.375  
 DORS18-LEFT TH15/16  
(TOLERANCE .0002)

RIVET295 3/8 004 14.625 14.75  
 DORS18-LEFT TH15/16  
(TOLERANCE .0002)  
\[/Perl\]  
В первой строке говорится, что заклепка 294 длиной в 3/4 дюйма расположена на 14,25 дюйма выше левого нижнего угла пластины 004. Вторая строка дополняет эту информацию о расположении заклепки, а третья строка содержит допуск (0,0002 дюйма), который дается на положение заклепки и размеры заклепки. Конечно же, все производство наших заклепок было автоматизировано – даже если мегамастера могли бы ставить заклепки в соответствии с этими спецификациями, акционерам компаний будет спаться лучше, если они будут знать, что все Супер Заклепки ценой по $4.99 за дюжину, не будут виновны в начале третьей мировой войны. (Просто представьте, какие в этом случае будут судебные иски!) В любом случае, извлечение этих полей легко – просто split() по пробелам:  
\[Perl\]  
while () {  
 @fields = split(/s+/, $\_) if /^RIVET/;  
\[/Perl\]  
К счастью, Perl поддерживает регулярные выражения, которые делают разбор допуска также легким:  
\[Perl\]  
 $tolerance = /TOLERANCEs+(.d+)/ if /TOLERANCE/;  
 # rest of code will be declassified in 25 years  
}  
\[/Perl\]  
Ой! Когда выражение просчитывается в контексте скаляра, оно возвращает 1 при успехе и UNDEF при сбое. Моя программа невольно возвращает для каждого допуска значение 1, поскольку я забыл скобки:  
\[Perl\]  
($tolerance) = /TOLERANCEs+(.d+)/ if /TOLERANCE/;  
\[/Perl\]  
В любом проекте, относящемся к ядерному оружию, имеется лютая команда профессионалов по контролю качества, которые нацеливают свои «пушки» техник проверки для выявления возможных багов. К счастью, и это может восстановить вашу веру в военных, они нашли мою ошибку до того, как фрезерный станок произвел заклепку, которой было суждено выпасть в верхних слоях атмосферы.

Позднее расследование показало, что таких ошибок я сделал тринадцать. Все они были быстро исправлены и не никогда не представляли серьезной угрозы.

**Немного ракетной науки**

С софтом для нацеливания ракеты мне не так повезло. Если вы помните ВУЗовский курс физики, вы помните, что объекты падают по параболе. Управляемые ракеты вроде Nike не могут быть подброшены в воздух как мячик, чтобы порадовать некоторых бригадных генералов, желающих остаться неизвестными. Управляемые ракеты должны двигаться на своей тяге.

Высота полета МБР достаточно велика для того, чтобы гравитация Земли ослабела, но не достаточно для её полного преодоления. Намного хуже набор климатических помех, каждый из которых стремится сдвинуть ракету с её смертоносного курса. Ветер, осадки, изменение геометрии от изменения температур, скопление пыли, песка и различного мусора – вот небольшой список малых угроз для нашей Одной Большой Угрозы.

Непредсказуемость этих ситуаций означает, что наша ракета должна быть реактивной. Они должны постоянно и детально корректировать свой полет, и вычисления должны выполняться с большой скоростью и точностью. Ошибка в одну сотую процента даст попадание вместо города в близлежащую ферму, в одну десятую процента – разница между Багдадом и Хайфой, ошибка в десять процентов – разница между Северным полюсом и Бостоном.

Еще больше осложняет динамику движения ракеты постоянная потеря массы во время полета. По мере сгорания жидкого топлива, которое вырывается из задней части ракеты, ракета становится легче и её становится все легче и легче двигать.

Тяга ракеты равна начальной скорости v0, умноженной на массу топлива, истекающего из ракеты за время dt:

thrust = v0 \* dM / dt.

Масса истекающего топлива, dM, равна плотности топлива (p), умноженной на площадь поперечного сечения отверстия (A0) умноженной на скорость истечения топлива (v0) и умноженной на изменение времени dt. “dt” сокращается и мы получаем следующее уравнение тяги:

thrust=p\*A0\*v0^2

Оно может быть записано на Perl как:  
\[perl\]  
$thrust = $rho \* $A0 \* ($v0 \*\* 2);  
\[/perl\]  
Если сечение отверстий мало, то скорость, с которой топливо выливается, может быть аппроксимировано как:

v0 = sqrt(2(p-p0)/p)

Nike, однако, было необходимо очень много топлива. Малое отверстие привело бы к увеличению давления внутри бака до неприемлемого уровня, поэтому его сечение было увеличено до значения, когда приближенная формула уже не работала. Вместо того, чтобы использовать квадратный корень, нужно было использовать степень 0,52 или 0,53. Как любой хороший программист, когда я узнал, что это значение может быть изменено, я поместил его в константу. Многие люди не понимают, что Perl позволяет создавать константы таким образом:  
\[perl\]  
\*expo = 0.52;  
\[/perl\]  
Здесь определена константа $expo, равная 0,52 и она защищена от последующих изменений. Например, выражение $expo++ приведет к фатальной ошибке:

Modification of a read-only value attempted at ./targetting line 1260.

Тем не менее, вот пример того, как я использовал $expo в моей программе на Perl:  
\[perl\]  
$thrust = $rho \* $A0 \* (2 \* ($p-$p0) / $rho) \*\* $expo \*\* 2);  
\[/perl\]  
Вы видите мою ошибку? Если да, то для вас есть работа в области контроля качества авионики, учитывая, что там еще работают компьютеры, пережившие эру пост-Холокоста.

А проблема вот в чем: оператор \*\* является правоассоциативным (можете почитать соответствующий раздел документации, если мне вы не доверяете). Это означает, что:  
\[perl\]  
$a \*\* $b \*\* $c  
\[/perl\]  
не то же, что и  
\[perl\]  
($a \*\* $b) \*\* $c  
\[/perl\]  
как я полагал, а на самом деле:  
\[perl\]  
$a \*\* ($b \*\* $c)  
\[/perl\]  
Это большая проблема, когда $a, или 2 \* ($p – $p0) / $rho в моем коде примерно равняется двум миллионам, $b равно 0,52, а $c равно 2. Perl не соглашается с физикой с коэффициентом более, чем четыре, и в этой битве физика побеждает. Эта ошибка осталась незамеченной, когда мой код на Perl был переведен на C с использованием Perl-компилятора, а из C в машинный код, который затем был «зажжен» в EPROM ракеты. Шесть недель спустя, ракеты были помещены в свои шахты вместе с инерциальной системой наведения, базирующейся на моем коде. Если бы они были запущены, то ошибка наведения составляла бы тысячи миль.

Ни –w, ни STRICT-режим не отлавливают эту ошибку. Я узнал об ошибке только после начала нового проекта, в котором мы сканировали огромные базы данных в поисках фраз, относящихся к национальной безопасности. Мой начальник сказал мне, что это нужно для организации и категоризации сорока гигабайт текстовых данных, которые NORAD планирует положить в локальную сеть. И я верил ему до тех пор, пока не узнал, что он ежемесячно ездит в штаб-квартиру Cisco в Сан-Хосе. Как оказалось, моя программа сканирования была тайно установлено на значительное количество роутеров Cisco, после чего Министерство Обороны могло следить за подозреваемыми в шпионаже.

В конце концов, убедившись, что я не из «свободолюбивых гражданских хиппи», мой начальник раскрылся. Я не думаю, что моё непосредственное начальство очень доверяло мне – скорее это произошло потому, что придурки в Пентагоне были больны моей программой, популярность которой росла по мере добавления к письмам полей вроде следующего:

From: liberal@bleeding-heart.org  
To: commie@progressive.edu  
Subject: The Man keeps putting us down  
X-NSA: Ortega SDI genetic Khaddafi bullion Cocaine munitions

Вы радикал, мыслящий мятежно и противоправительственно, который использует эти заголовки? Вы хотите сорвать зловещие попытки Большого Брата проверять всю массу сообщений от либерала к либералу каждый день? Тогда у меня есть для вас три слова (ну, точнее, два слова и регулярное выражение):  
\[perl\]  
next if /^X-NSA/;  
\[/perl\]  
И вот, во время работы над этим проектом я обнаружил мою ошибку в операторе возведения в степень. В частности, я развивал эвристики для обработки строк с опечатками более решительно. Вы можете удивиться, как много людей опечатываются в слове «ядерный», не говоря уже о «клистроне». Я использовал модуль String::Approx, который для каждой строки возвращал список похожих строк, которые могли быть использованы в регулярном выражении. Чем длиннее строка, тем больше число возможных вариантов. К счастью, соотношение между длиной строки и количеством близких совпадений является экспоненциальным. В противном случае, ошибка в ПО наведения могла бы остаться незамеченной и по сей день. Спите спокойно.

**Боевая тревога!**

Иногда я думаю, что работающих в NORAD можно сравнить с системным администратором. Пока вы делаете свою работу хорошо, все остальные безнаказанно игнорируют вас. И только когда назревает кризис, люди начинают вас замечать, причем, без особых любезностей.

Однако если вы когда-нибудь сможете воочию наблюдать полномасштабный военный кризис, это будет незабываемый опыт. Это вроде как пожарная сигнализация в средней школе. Вначале ты уверен, что это ложная тревога. Ты ведешь себя, как будто это большая шутка. Но маленькая часть внутри вас беспокоится, что очень скоро вся школа будет охвачена адом, и вы пропустите свой выпускной.

Когда я обнаружил свою ошибку, я не мог просто сказать: «Ой, я нашел ошибку, выключите, пожалуйста, пока все ядерные ракеты, чтобы я мог исправить свой код – нажмите тот рычажок на стене, рядом с лампочкой». Нет, отключение нашего оборонительного оружия – сложная задача. Вы же не хотите, чтобы мы на время остались с парализованными запасами ядерных бомб? В то же время, разрешение таких проблем должно происходить быстро. Наши ядерные ракеты фактически работали в автономном режиме, поэтому если бы вдруг что-то произошло, то мы были бы бессильны против получения нескольких своих же урановых сюрпризов.

Я сказал своему начальнику, он сказал своему полковнику, тот рявкнул на одного из своих помощников, который напечатал кое-чего в своем компьютере, который мне не разрешалось даже видеть. Начался SPAM. SPAM означает Совещание по Поводу Потенциального Армагеддона (Standby Potential Armageddon Meeting), под председательством командующего NORAD. Во время каждого SPAMа, взвывали сирены, мигали красные эпилептические огоньки, а телефоны звонили напрямую в номера находящихся в отпуске четырехзвездочных генералов. Каждый SPAM вызывает автоматическое увеличение уровня угрозы до третьего уровня, что означает телефонный звонок прямо в ставку главнокомандующего – нашего Президента. (Я посылал по электронной почте потом ему свои извинения на whitehouse.gov, но ответа не последовало).

Главный командир, да будет благословенно его дисциплинированное сердце, понял, что там была проблема с EPROM и начал обсуждение с вопроса, где мы можем закупить новые EPROM. Мой командир объяснил, что это не так просто, что мы не можем просто опустить к NORAD генеральский магазин, чтобы купить новые EPROM из торгового автомата. Он объяснил, что необходимо создать программу, прожечь её в новые EPROM, а затем, он терпеливо объяснил, что «прожечь» здесь не имеет ничего общего с напалмом.

Также он стал объяснять, что могут быть разные ошибки – не просто опечатки, а, как здесь, недопонимание мною Perl. Возник вопрос, как бы мы могли обнаружить и исправить все эти ошибки сразу. Главный командир обошел вокруг стола и спросил каждого из нас, какие мы можем дать рекомендации на этот счет. Один офицер предложил воспользоваться старыми EPROM, которые не были запятнаны таким бедствием, как Perl. Мой капитан не согласился, заявив, что старые программы наведения были слишком неточными, поэтому у нас не было выбора, кроме как исправить наши текущие программы наведения вручную, проверив каждую из тридцати восьми программ, которые я написал. Я смиренно предложил, что задача поиска ошибок и их исправление могут быть автоматизированы скриптом на Perl. Это была та вещь, после которой меня попросили покинуть комнату…